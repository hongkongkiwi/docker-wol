#!/usr/bin/with-contenv bash

WOL_SCRIPT="$WOL_LOCAL_DIR/wol.py"
TIMEOUT_SECONDS=2
command -v "$WOL_SCRIPT" >/dev/null 2>&1 || { echo >&2 "I require $WOL_SCRIPT but it's not installed.  Aborting."; exit 1; }
command -v "nc" >/dev/null 2>&1 || { echo >&2 "I require nc but it's not installed.  Aborting."; exit 1; }

if [ -n "$HOSTS_TO_CHECK" ] && [ -n "$BROADCAST_IP" ] && [ -n "$WOL_PORT" ]; then
  IS_VERBOSE=`[ "$VERBOSE" == "yes" ] && echo "-v"`
  IFS=","
  for HOST_PORT in $HOSTS_TO_CHECK
  do
    PORT=`echo "$HOST_PORT" | cut -f3 -d '/'`
    HOST=`echo "$HOST_PORT" | cut -f1 -d '/'`
    MAC=`echo "$HOST_PORT" | cut -f2 -d '/'`
    [ "$HOST" == "" ] && continue
    [ [ "$PORT" == "0" ] || [ "$PORT" == "" ] ] && continue
    IS_REACHABLE=`nc -w $TIMEOUT_SECONDS "$HOST" $PORT </dev/null; echo $?`
    if [ "$IS_REACHABLE" != "0" ]; then
      "$WOL_SCRIPT" -p "$WOL_PORT" -i "$BROADCAST_IP" -m "$HOST" $IS_VERBOSE
    fi
  done
fi
